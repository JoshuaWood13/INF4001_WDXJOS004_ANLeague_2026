@model INF4001_WDXJOS004_ANLeague_2026.Models.ViewModels.MatchDetailViewModel

@functions {
    // Convert event type enums to a more user-friendly format
    string FormatEventType(string eventType)
    {
        return System.Text.RegularExpressions.Regex.Replace(eventType, "(\\B[A-Z])", " $1");
    }
}

<link rel="stylesheet" href="~/css/match-details.css" asp-append-version="true" />

@if (Model.IsLoading)
{ 
    <!-- Data container for JS -->
    <div id="matchDetailsData" 
         data-match-id="@Model.Match.Id" 
         data-mode="@Model.Mode" 
         data-stream-url="@Url.Action("StreamMatchCommentary", "Tournament")?matchId=@Model.Match.Id&mode=@Model.Mode" 
         style="display: none;">
    </div>
}

<div class="container mt-4">

    <!-- Match Header -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white position-relative">
            <a href="@Url.Action("Tournament", "Tournament")" class="btn btn-outline-dark btn-sm position-absolute" style="left: 15px; top: 50%; transform: translateY(-50%);">
                Back
            </a>
            <h3 class="mb-0 text-center">@Model.Match.Round</h3>
        </div>
        <div class="card-body">
            <div class="match-header-content">
                <div class="team-info home-team">
                    <h1 class="team-name">@Model.HomeCountryName</h1>
                    <div class="team-label">Home</div>
                </div>
                
                <!-- Score -->
                <div class="score-display">
                    <div>
                        <span class="score" id="homeScore">@Model.Match.HomeScore</span>
                        <span class="score-separator">-</span>
                        <span class="score" id="awayScore">@Model.Match.AwayScore</span>
                    </div>
                    <div class="match-type-badge">@Model.MatchType.ToString()</div>
                </div>
                
                <div class="team-info away-team">
                    <h1 class="team-name">@Model.AwayCountryName</h1>
                    <div class="team-label">Away</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Match Events -->
    <div class="card shadow">
        <div class="card-header bg-info text-white">
            <h3 class="mb-0">Match Events</h3>
        </div>
        <div class="card-body">
            @if (Model.IsLoading)
            {
                <div id="loadingState" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="text-muted">Generating match commentary...</h5>
                    <p class="text-muted">Events will appear as they unfold</p>
                </div>
            }
            <div id="eventsList" class="events-list" style="@(Model.IsLoading ? "display:none;" : "")">
                @if (Model.Commentary != null && Model.Commentary.Any())
                {
                    @foreach (var moment in Model.Commentary.OrderBy(c => c.Minute))
                    {
                        <div class="event-item @moment.Type.ToString().ToLower()">
                            <div class="event-header">
                                <span class="event-time">@moment.Minute'</span>
                                <span class="event-type">@FormatEventType(moment.Type.ToString())</span>
                            </div>
                            <div class="event-description">@moment.Description</div>
                            
                            @if (moment.Type == INF4001_WDXJOS004_ANLeague_2026.Models.Enums.CommentaryType.Goal)
                            {
                                <div class="event-score">Score: @moment.HomeScore - @moment.AwayScore</div>
                            }
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@if (Model.IsLoading)
{
    <script src="~/js/match-details.js" asp-append-version="true"></script>
}
